<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Refuel Assist v7.3</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="assets/logo-192.png">
    <link rel="apple-touch-icon" href="assets/logo-192.png">
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --amber: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: white; margin: 0; display: flex; justify-content: center; overflow-x: hidden; overflow-y: auto; height: auto; min-height: 100dvh; }
        .page { width: 100%; max-width: 420px; padding: 12px; box-sizing: border-box; overflow-y: auto; height: auto; min-height: 100dvh; }
        .hero-section { text-align: center; margin-bottom: 40px; }
        .app-logo { width: 128px; height: auto; display: block; margin: 0 auto 2px auto; }
        .logo-text { font-size: 34px; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 0; }
        .logo-text .bold { font-weight: 900; letter-spacing: -1px; }
        .logo-text .light { font-weight: 200; color: var(--primary); letter-spacing: 4px; }
        .logo-subtitle { font-size: 11px; font-weight: 700; color: #64748b; letter-spacing: 3px; text-transform: uppercase; margin-top: 5px; }
        .logo-line { height: 1px; width: 180px; background: linear-gradient(90deg, transparent, var(--primary), transparent); margin: 20px auto; opacity: 0.3; }
        .fleet-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .fleet-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255,255,255,0.10);
            width: 100%;
            min-height: 72px;
            padding: 28px 18px;
            border-radius: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.18s cubic-bezier(.4,1.4,.6,1), background 0.18s, border-color 0.18s;
            box-sizing: border-box;
            text-decoration: none;
            color: inherit;
            user-select: none;
            touch-action: manipulation;
        }
        .fleet-card:active, .fleet-card.pressed {
            transform: scale(0.97);
            background: rgba(56, 189, 248, 0.13);
            border-color: var(--primary);
        }
        .brand-card-wrap.selected .fleet-card {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.18);
            background: rgba(56, 189, 248, 0.10);
        }
        .fleet-logo {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: none;
        }
        .fleet-logo img.brand-logo {
            width: 56px;
            height: 56px;
            display: block;
            object-fit: contain;
            margin-top: 1px;
            margin-bottom: 1px;
            transform-origin: 50% 50%;
        }
        /* Algısal eşitlik için daha agresif scale */
        .fleet-logo img.brand-logo.brand-airbus { transform: scale(1.22); }
        .fleet-logo img.brand-logo.brand-boeing { transform: scale(0.85); }
        .brand-badge {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 1000;
            letter-spacing: 0.5px;
            color: white;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(56,189,248,0.12);
        }
        .fleet-info { flex-grow: 1; }
        .fleet-card h2 { margin: 0; font-size: 18px; font-weight: 800; color: #fff; }
        .fleet-card .limits { margin-top: 4px; font-size: 9px; color: #94a3b8; font-weight: 600; letter-spacing: 0.5px; }
        .fleet-card .max-val { margin-top: 6px; font-size: 11px; color: var(--primary); font-weight: 800; }

        .selector-panel {
            background: rgba(30, 41, 59, 0.45);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 14px;
        }
        .selector-title {
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #94a3b8;
            margin: 0 0 10px 0;
            text-align: center;
        }
        .selector-row { display: flex; gap: 10px; align-items: center; justify-content: center; }
        .selector-input, .selector-select {
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255,255,255,0.10);
            color: white;
            border-radius: 14px;
            padding: 12px 12px;
            font-size: 12px;
            font-weight: 800;
            outline: none;
            box-sizing: border-box;
        }
        /* Sadece kuyruk kodu input'u dar ve ortalı olsun */
        #tail-input.selector-input {
            width: 160px;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px 14px 10px 16px;
            font-size: 20px;
            text-align: center;
            display: block;
        }
        .selector-input::placeholder { color: #64748b; font-weight: 800; }
        .selector-hint {
            margin-top: 8px;
            font-size: 11px;
            font-weight: 700;
            line-height: 1.35;
            color: #94a3b8;
            text-align: center;
        }
        .brand-grid { display: flex; flex-direction: column; gap: 10px; }
        .brand-card-wrap {
            width: 100%;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(30, 41, 59, 0.35);
            border-radius: 20px;
            padding: 14px;
            box-sizing: border-box;
        }
        .brand-card {
            width: 100%;
            border: 0;
            background: transparent;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: inherit;
            text-align: left;
        }
        .brand-card:active { transform: scale(0.98); }
        .brand-card-wrap.selected { border-color: var(--primary); background: rgba(56, 189, 248, 0.08); }
        .brand-card .brand-name { margin: 0; font-size: 14px; font-weight: 900; }
        .brand-card .brand-sub { margin-top: 2px; font-size: 9px; font-weight: 800; letter-spacing: 0.4px; color: #94a3b8; }
        .brand-card-wrap .reveal { margin-top: 12px; }
        .btn-primary {
            width: 100%;
            margin-top: 14px;
            background: rgba(56,189,248,0.18);
            border: 2px solid rgba(56,189,248,0.28);
            color: white;
            padding: 10px 0;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 900;
            letter-spacing: 0.8px;
            cursor: pointer;
            min-height: 36px;
            user-select: none;
            touch-action: manipulation;
            transition: background 0.2s, border 0.2s, box-shadow 0.2s;
        }
        .btn-primary:active {
            background: rgba(56,189,248,0.28);
            border-color: var(--primary);
        }
        .btn-primary:disabled { opacity: 0.30; cursor: not-allowed; }
        .divider-note {
            margin: 6px 0 0 0;
            text-align: center;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.8px;
            color: #64748b;
            text-transform: uppercase;
        }

        .lang-toggle {
            display: inline-flex;
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(30, 41, 59, 0.55);
            backdrop-filter: blur(10px);
            overflow: hidden;
            margin-top: 10px;
        }
        .lang-toggle button {
            appearance: none;
            border: 0;
            background: transparent;
            color: #94a3b8;
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 0.6px;
            cursor: pointer;
            line-height: 1;
        }
        .lang-toggle button.active {
            color: white;
            background: rgba(56,189,248,0.18);
        }

        .reveal {
            overflow: hidden;
            max-height: 240px;
            opacity: 1;
            transform: translateY(0);
            transition: max-height 260ms ease, opacity 220ms ease, transform 220ms ease;
        }
        .reveal.is-hidden {
            max-height: 0;
            opacity: 0;
            transform: translateY(-6px);
        }
        .is-hidden {
            display: none !important;
        }

        .mini-pill {
            appearance: none;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(30, 41, 59, 0.55);
            color: #94a3b8;
            padding: 10px 12px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 0.6px;
            cursor: pointer;
            line-height: 1;
            user-select: none;
            touch-action: manipulation;
        }
        .mini-pill.primary {
            color: white;
            background: rgba(56,189,248,0.18);
            border-color: rgba(56,189,248,0.28);
        }
    </style>
</head>
<body>
    <div class="page" style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); overflow-y: auto; height: auto; min-height: 100dvh;">
        <div class="hero-section" style="margin-bottom: 18px;">
            <img class="app-logo" src="assets/logo-512.png" alt="Refuel Assist" style="width:96px;max-width:96px;">
            <div class="logo-text" style="font-size:26px;"><span class="bold">REFUEL</span><span class="light">ASSIST</span></div>
            <div id="subtitle" class="logo-subtitle" style="font-size:10px;">Flight Operations Support</div>
            <div class="lang-toggle" role="group" aria-label="Language" style="margin-top:6px;">
                <button id="lang-tr" type="button">TR</button>
                <button id="lang-en" type="button">EN</button>
            </div>
            <div class="logo-line" style="width:120px;margin:12px auto;"></div>
        </div>

        <!-- Kılavuz erişimi (kapak sayfası) -->
        <div style="width:100%;max-width:420px;padding:0 4px;box-sizing:border-box;margin-bottom:10px;">
            <div style="display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;">
                <button id="guide-open" type="button" class="mini-pill primary">KULLANIM KILAVUZU</button>
                <button id="guide-reset" type="button" class="mini-pill" style="display:none;">Kılavuzu tekrar göster</button>
            </div>
        </div>

        <!-- Kullanım Kılavuzu Modalı -->
        <div id="guide-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100dvh;background:rgba(15,23,42,0.82);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
            <div style="background:rgba(30,41,59,0.98);border-radius:18px;max-width:370px;width:92vw;padding:18px 18px 16px 18px;box-shadow:0 8px 32px 0 rgba(56,189,248,0.13);color:#e0f2fe;position:relative;max-height:78vh;overflow:auto;-webkit-overflow-scrolling:touch;">
                <button id="guide-close" title="Kapat" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#38bdf8;font-size:22px;font-weight:900;cursor:pointer;">×</button>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#38bdf8" opacity="0.18"/><circle cx="12" cy="12" r="9.5" fill="#38bdf8"/><text x="12" y="17" text-anchor="middle" font-size="13" font-family="Segoe UI,Arial,sans-serif" fill="#fff" font-weight="bold">i</text></svg>
                    <span id="guide-title" style="color:#38bdf8;font-weight:900;font-size:16px;">Kullanım Kılavuzu</span>
                </div>
                <ol id="guide-steps" style="margin:0 0 0 18px;padding:0;list-style:decimal;color:#e0f2fe;font-size:13px;line-height:1.65;">
                    <li>…</li>
                </ol>
                <div id="guide-foot" style="margin-top:12px;font-size:12px;color:#94a3b8;">Bu pencere ilk kullanımda bir kez otomatik gösterilir.</div>
            </div>
        </div>

        <div class="fleet-container" style="gap:10px;">
            <div id="brand-hint" style="display:flex;align-items:center;gap:10px;max-width:96%;background:rgba(56,189,248,0.07);border-radius:12px;padding:10px 12px 8px 12px;margin-bottom:14px;box-shadow:0 1px 6px 0 rgba(56,189,248,0.05);font-size:15px;font-weight:700;line-height:1.4;color:#38bdf8;letter-spacing:0.1px;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;"><circle cx="12" cy="12" r="12" fill="#38bdf8" opacity="0.18"/><circle cx="12" cy="12" r="9.5" fill="#38bdf8"/><text x="12" y="17" text-anchor="middle" font-size="13" font-family="Segoe UI,Arial,sans-serif" fill="#fff" font-weight="bold">i</text></svg>
                <span>Kuyruk kodu girin veya marka/model seçin</span>
            </div>
            <div class="selector-panel" id="tail-panel">
                <div id="tail-title" class="selector-title">TAIL CODE</div>
                <div class="selector-row">
                    <input id="tail-input" class="selector-input" type="text" inputmode="text" autocapitalize="characters" autocomplete="off" spellcheck="false" placeholder="TC-___" aria-label="Tail Code">
                </div>
                <div id="tail-hint" class="selector-hint">Enter a tail code to auto-select brand and model.</div>
            </div>

            <div class="selector-panel" id="advanced-panel">
                <div id="adv-title" class="selector-title">MODEL SELECTION</div>

                <div class="brand-grid" aria-label="Brand">
                    <div id="brand-airbus-wrap" class="brand-card-wrap">
                        <button id="brand-airbus" type="button" class="brand-card" data-oem="AIRBUS">
                            <div class="fleet-logo" aria-hidden="true"><img class="brand-logo brand-airbus" src="assets/airbus.svg" alt=""></div>
                            <div class="fleet-info">
                                <h3 class="brand-name">Airbus</h3>
                                <div class="brand-sub" id="brand-airbus-sub">Select family & model</div>
                            </div>
                        </button>
                    </div>
                    <div id="brand-boeing-wrap" class="brand-card-wrap">
                        <button id="brand-boeing" type="button" class="brand-card" data-oem="BOEING">
                            <div class="fleet-logo" aria-hidden="true"><img class="brand-logo brand-boeing" src="assets/boeing.svg" alt=""></div>
                            <div class="fleet-info">
                                <h3 class="brand-name">Boeing</h3>
                                <div class="brand-sub" id="brand-boeing-sub">Select family & model</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div id="selectors-host">
                    <div id="model-row" class="reveal is-hidden">
                        <div class="selector-row">
                            <select id="model-select" class="selector-select" aria-label="Model" disabled>
                                <option value="">Model</option>
                            </select>
                        </div>
                    </div>

                    <div id="variant-row" class="reveal is-hidden">
                        <div class="selector-row">
                            <select id="variant-select" class="selector-select" aria-label="Variant" disabled>
                                <option value="">Variant</option>
                            </select>
                        </div>
                        <div class="selector-row is-hidden" id="act-row">
                            <select id="act-select" class="selector-select" aria-label="ACT Option">
                            </select>
                        </div>
                    </div>
                </div>

                <button id="go-btn" type="button" class="btn-primary" disabled>OPEN CALCULATOR</button>
                <div id="go-alert" style="display:none;position:absolute;left:0;right:0;top:0;margin:auto;text-align:center;color:#f59e0b;font-weight:900;font-size:13px;z-index:10;transition:opacity 0.4s;opacity:0;pointer-events:none;">Lütfen önce bir marka ve model seçin.</div>
                <div id="go-hint" class="selector-hint" style="margin-top: 8px;">Some widebody types may not be configured yet.</div>
            </div>

        </div>
    </div>


    <script src="assets/tailCapacityLoader.js"></script>
    <script>
    // Service worker kaydı (offline + PWA installability için)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => { try { reg.update(); } catch (e) {} })
                .catch(() => {});
        });
    }

    // İlk girişte (kurulu değilse) yükleme sayfasına yönlendir
    (function redirectToInstallIfNeeded(){
        const SKIP_INSTALL_KEY = 'refuel_assist_skip_install_v1';
        function isStandaloneMode() {
            try {
                if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return true;
                if (typeof navigator.standalone === 'boolean' && navigator.standalone) return true;
            } catch (e) {}
            return false;
        }

        if (isStandaloneMode()) return;

        try {
            const url = new URL(window.location.href);
            if (url.searchParams.get('skipInstall') === '1') {
                try { localStorage.setItem(SKIP_INSTALL_KEY, '1'); } catch (e) {}
                url.searchParams.delete('skipInstall');
                window.history.replaceState({}, '', url.toString());
            }
        } catch (e) {}

        let skip = false;
        try { skip = localStorage.getItem(SKIP_INSTALL_KEY) === '1'; } catch (e) {}
        if (!skip) {
            // Yeni kullanıcılar önce yükleme/onboarding sayfasını görsün
            window.location.replace('./install.html');
        }
    })();

    // Uyarı kutusunu giriş yapınca gizle
    function hideBrandHint() {
        var el = document.getElementById('brand-hint');
        if(el) el.style.display = 'none';
    }
    // Kuyruk kodu girilince
    document.getElementById('tail-input')?.addEventListener('input', function(e) {
        if(this.value && this.value.length > 2) hideBrandHint();
    });
    // Marka/model seçilince (button click)
    document.getElementById('brand-airbus')?.addEventListener('click', hideBrandHint);
    document.getElementById('brand-boeing')?.addEventListener('click', hideBrandHint);
    // Dokunmatik için pressed class toggle
    document.querySelectorAll('.brand-card').forEach(function(btn){
        btn.addEventListener('touchstart',function(){btn.classList.add('pressed');});
        btn.addEventListener('touchend',function(){btn.classList.remove('pressed');});
        btn.addEventListener('touchcancel',function(){btn.classList.remove('pressed');});
    });

    // Seçim yapılmadan butona basılırsa uyarı göster
    var goBtn = document.getElementById('go-btn');
    var goAlert = document.getElementById('go-alert');
    if(goBtn && goAlert){
        goBtn.addEventListener('click',function(e){
            if(goBtn.disabled){
                goAlert.style.display='block';
                goAlert.style.opacity='1';
                setTimeout(function(){
                    goAlert.style.opacity='0';
                    setTimeout(function(){goAlert.style.display='none';},400);
                },1800);
            }
        });
    }
    (function initI18n() {
        const STORAGE_KEY = 'refuel_assist_lang';
        const GUIDE_SEEN_KEY = 'refuel_assist_seen_guide_v1';
        const I18N = {
            tr: {
                subtitle: 'Uçuş Operasyon Destek',
                fleet_a320_title: 'Airbus A320 Family',
                fleet_b737_title: 'Boeing 737 NG/MAX',

                tail_title: 'KUYRUK KODU',
                tail_ph: 'TC-___',
                tail_hint_idle: 'Kuyruk kodunu TC- sonrası 3 karakter girin.',
                tail_hint_loading: 'Filo listesi yükleniyor…',
                tail_hint_notfound: 'Kuyruk kodu bulunamadı. Yazımı kontrol edin.',
                tail_hint_found: 'Kuyruk bulundu: {model}{variant}',

                adv_title: 'MODEL SEÇİMİ',
                brand_sub: 'Model ve varyant seç',
                model_placeholder: 'Model',
                variant_placeholder: 'Varyant',
                go_btn: 'HESAPLAMAYA GİT',
                go_hint_idle: 'Bazı geniş gövde tipleri henüz tanımlı olmayabilir.',
                go_hint_unsupported: 'Seçilen tip için tank limitleri tanımlı değil.',
                go_hint_widebody: 'Geniş gövde için limitler zorlanmaz (placard/AMM önceliklidir).',
                quick_note: 'Hızlı Seçim',
                guide_btn: 'KULLANIM KILAVUZU',
                guide_title: 'Kullanım Kılavuzu',
                guide_steps_html: [
                    '<li><b>Kurulum:</b> Yükleme ekranında isterseniz uygulamayı kurun; isterseniz <b>"Yüklemeden denemek istiyorum"</b> ile devam edin.</li>',
                    '<li><b>Uçak seçimi (Kapak):</b> Kuyruk kodunu girin (örn. TC-ABC) veya marka/model/varyant seçin.</li>',
                    '<li><b>Hesaplamaya geçiş:</b> <b>"HESAPLAMAYA GİT"</b> ile hesaplama ekranını açın.</li>',
                    '<li><b>Hesaplama girişleri:</b> <b>Blok Yakıt</b>, <b>İkmal Öncesi Yakıt (FOB)</b> (toplam veya tank), <b>Yoğunluk</b> ve <b>Sıcaklık</b> değerlerini girin.</li>',
                    '<li><b>Sonuçlar:</b> Hedef tank değerleri (LH/CENTER/RH) ve <b>İkmal</b> (KG/LTR) sonucu oluşur. Limit/uyarı mesajlarını kontrol edin.</li>',
                    '<li><b>Kayıt & fiş:</b> <b>"KAYDET & FİŞİ GÖR"</b> ile kaydedin; fiş (receipt) otomatik açılır.</li>',
                    '<li><b>Kayıtlar:</b> Hesaplama ekranındaki <b>"KAYITLAR"</b> butonuyla geçmişe gidin. Kayda tıklayınca fiş açılır; <b>×</b> ile silin; <b>"TÜMÜNÜ SİL"</b> ile tüm geçmişi temizleyin.</li>',
                    '<li><b>Diğer:</b> <b>"SIFIRLA"</b> hesabı temizler. <b>"UYARILAR & ÖNLEMLER"</b> güvenlik hatırlatmalarını gösterir.</li>'
                ].join(''),
                guide_foot: 'Bu pencere ilk kullanımda bir kez otomatik gösterilir.'
                ,
                sw_update_ready: 'Yeni sürüm hazır.',
                sw_update_reload: 'YENİLE',
                act_none: 'İlave Merkez Tank Yok',
                act_1: '1 İlave Merkez Tank',
                act_2: '2 İlave Merkez Tank',
                act_3: '3 İlave Merkez Tank',
                act_placeholder: 'ACT Seçeneği'
            },
            en: {
                subtitle: 'Flight Operations Support',
                fleet_a320_title: 'Airbus A320 Family',
                fleet_b737_title: 'Boeing 737 NG/MAX',

                tail_title: 'TAIL CODE',
                tail_ph: 'TC-___',
                tail_hint_idle: 'Enter 3 characters after TC-.',
                tail_hint_loading: 'Loading fleet list…',
                tail_hint_notfound: 'Tail code not found. Check spelling.',
                tail_hint_found: 'Tail found: {model}{variant}',

                adv_title: 'MODEL SELECTION',
                brand_sub: 'Select model & variant',
                model_placeholder: 'Model',
                variant_placeholder: 'Variant',
                go_btn: 'OPEN CALCULATOR',
                go_hint_idle: 'Some widebody types may not be configured yet.',
                go_hint_unsupported: 'Tank limits are not configured for this type.',
                go_hint_widebody: 'Widebody runs without enforced limits (placard/AMM takes priority).',
                quick_note: 'Quick Select',
                guide_btn: 'USER GUIDE',
                guide_title: 'User Guide',
                guide_steps_html: [
                    '<li><b>Install:</b> On the install page you can install the app, or continue with <b>"Try without installing"</b>.</li>',
                    '<li><b>Aircraft selection (Cover):</b> Enter tail code (e.g., TC-ABC) or select brand/model/variant.</li>',
                    '<li><b>Open calculator:</b> Tap <b>"OPEN CALCULATOR"</b> to enter the calculation page.</li>',
                    '<li><b>Calculator inputs:</b> Enter <b>Block Fuel</b>, <b>Fuel On Board</b> (total or tanks), <b>Density</b>, and <b>Temperature</b>.</li>',
                    '<li><b>Results:</b> Target tank values (LH/CENTER/RH) and <b>Uplift</b> (KG/LTR) are shown. Check limit/warning messages.</li>',
                    '<li><b>Save & receipt:</b> Use <b>"SAVE & VIEW RECEIPT"</b> to save; the receipt opens automatically.</li>',
                    '<li><b>Logs:</b> Use <b>"LOGS"</b>. Tap an entry to open the receipt; delete with <b>×</b>; remove all with <b>"CLEAR ALL"</b>.</li>',
                    '<li><b>Other:</b> <b>"RESET"</b> clears inputs. <b>"WARNINGS & PRECAUTIONS"</b> shows safety reminders.</li>'
                ].join(''),
                guide_foot: 'This dialog is auto-shown once on first use.'
                ,
                sw_update_ready: 'A new version is ready.',
                sw_update_reload: 'RELOAD',
                act_none: 'No Additional Centre Tank',
                act_1: '1 Additional Centre Tank',
                act_2: '2 Additional Centre Tank',
                act_3: '3 Additional Centre Tank',
                act_placeholder: 'ACT Option'
            }
        };

        function t(lang, key, vars) {
            const dict = I18N[lang] || I18N.tr;
            let s = String(dict[key] ?? '');
            if (vars) {
                for (const k of Object.keys(vars)) {
                    s = s.replaceAll('{' + k + '}', String(vars[k]));
                }
            }
            return s;
        }

        function getLang() {
            const raw = (localStorage.getItem(STORAGE_KEY) || '').toLowerCase();
            return raw === 'en' ? 'en' : 'tr';
        }

        function setLang(lang) {
            const next = lang === 'en' ? 'en' : 'tr';
            localStorage.setItem(STORAGE_KEY, next);
            applyLang(next);
        }

        function applyLang(lang) {
            document.documentElement.lang = lang;

            const dict = I18N[lang] || I18N.tr;
            const subtitle = document.getElementById('subtitle');
            const a320Title = document.getElementById('fleet-a320-title');
            const b737Title = document.getElementById('fleet-b737-title');
            if (subtitle) subtitle.textContent = dict.subtitle;
            if (a320Title) a320Title.textContent = dict.fleet_a320_title;
            if (b737Title) b737Title.textContent = dict.fleet_b737_title;

            const tailTitle = document.getElementById('tail-title');
            const tailInput = document.getElementById('tail-input');
            const tailHint = document.getElementById('tail-hint');
            const advTitle = document.getElementById('adv-title');
            const airbusSub = document.getElementById('brand-airbus-sub');
            const boeingSub = document.getElementById('brand-boeing-sub');
            const modelSelect = document.getElementById('model-select');
            const variantSelect = document.getElementById('variant-select');
            const goBtn = document.getElementById('go-btn');
            const goHint = document.getElementById('go-hint');
            const quickNote = document.getElementById('quick-note');

            if (tailTitle) tailTitle.textContent = dict.tail_title;
            if (tailInput) tailInput.placeholder = dict.tail_ph;
            if (tailHint && tailHint.dataset.state !== 'found' && tailHint.dataset.state !== 'notfound' && tailHint.dataset.state !== 'loading') {
                tailHint.textContent = dict.tail_hint_idle;
            }
            if (advTitle) advTitle.textContent = dict.adv_title;
            if (airbusSub) airbusSub.textContent = dict.brand_sub;
            if (boeingSub) boeingSub.textContent = dict.brand_sub;
            if (modelSelect && modelSelect.options.length) modelSelect.options[0].textContent = dict.model_placeholder;
            if (variantSelect && variantSelect.options.length) variantSelect.options[0].textContent = dict.variant_placeholder;
            if (goBtn) goBtn.textContent = dict.go_btn;
            if (goHint && goHint.dataset.state !== 'unsupported') goHint.textContent = dict.go_hint_idle;
            if (quickNote) quickNote.textContent = dict.quick_note;
            const guideBtn = document.getElementById('guide-open');
            const guideTitle = document.getElementById('guide-title');
            const guideSteps = document.getElementById('guide-steps');
            const guideFoot = document.getElementById('guide-foot');
            if (guideBtn) guideBtn.textContent = dict.guide_btn;
            if (guideTitle) guideTitle.textContent = dict.guide_title;
            if (guideSteps && dict.guide_steps_html) guideSteps.innerHTML = dict.guide_steps_html;
            if (guideFoot) guideFoot.textContent = dict.guide_foot;

            const swUpdateText = document.getElementById('sw-update-text');
            const swUpdateBtn = document.getElementById('sw-update-btn');
            if (swUpdateText) swUpdateText.textContent = dict.sw_update_ready;
            if (swUpdateBtn) swUpdateBtn.textContent = dict.sw_update_reload;

            const btnTr = document.getElementById('lang-tr');
            const btnEn = document.getElementById('lang-en');
            if (btnTr && btnEn) {
                btnTr.classList.toggle('active', lang === 'tr');
                btnEn.classList.toggle('active', lang === 'en');
            }
        }

        document.getElementById('lang-tr')?.addEventListener('click', () => setLang('tr'));
        document.getElementById('lang-en')?.addEventListener('click', () => setLang('en'));

        applyLang(getLang());

        // --- Onboarding: Guide ---
        const guideModal = document.getElementById('guide-modal');
        const guideOpen = document.getElementById('guide-open');
        const guideClose = document.getElementById('guide-close');
        const guideReset = document.getElementById('guide-reset');

        function openGuide() {
            if (!guideModal) return;
            guideModal.style.display = 'flex';
        }

        function closeGuide(setSeen) {
            if (!guideModal) return;
            guideModal.style.display = 'none';
            if (setSeen) {
                try { localStorage.setItem(GUIDE_SEEN_KEY, '1'); } catch (e) {}
            }
        }

        if (guideOpen) guideOpen.addEventListener('click', () => openGuide());
        if (guideClose) guideClose.addEventListener('click', () => closeGuide(true));
        if (guideModal) guideModal.addEventListener('click', (e) => { if (e.target === guideModal) closeGuide(true); });

        if (guideReset) {
            guideReset.addEventListener('click', () => {
                try { localStorage.removeItem(GUIDE_SEEN_KEY); } catch (e) {}
                openGuide();
            });
        }

        // İlk kullanımda kılavuz 1 kez otomatik açılsın
        (function autoGuideOnce(){
            let seen = false;
            try { seen = localStorage.getItem(GUIDE_SEEN_KEY) === '1'; } catch (e) {}
            if (!seen) {
                setTimeout(() => openGuide(), 700);
            }
        })();

        // --- Fleet selection (xlsx-based) ---
        const state = {
            dataReady: false,
            byOem: { AIRBUS: new Map(), BOEING: new Map() },
            tailMap: new Map(),
            selectedOem: '',
            selectedModel: '',
            selectedVariant: '',
            selectedAct: '',
            lockedByTail: false
        };

        function isSelectionComplete() {
            if (!state.selectedOem) return false;
            if (!state.selectedModel) return false;
            if (!state.selectedVariant) return false;
            // ACT satırı görünüyorsa sub varyant (ACT) seçimi de tamamlanmış olmalı
            const selectedValue = String(state.selectedVariant || '').trim().toUpperCase();
            const actShown = (String(state.selectedModel || '').toUpperCase() === 'A320 FAMILY') && selectedValue.startsWith('PW1100G');
            if (actShown && !state.selectedAct) return false;
            return true;
        }

        function selectionTankKey() {
            const fam = String(state.selectedModel || '').trim();
            const v = String(state.selectedVariant || '').trim();
            const famU = fam.toUpperCase();
            if (!fam) return '';

            // Narrowbody canonical keys
            if (famU === 'A320 FAMILY' || famU === 'A319' || famU === 'A320' || famU === 'A321') {
                const vU = v.toUpperCase();
                const act = String(state.selectedAct || '').trim().toUpperCase();
                // Eğer ACT seçiliyse, varyant ne olursa olsun A320neo-1ACT gibi anahtar dön
                if (act === '1ACT' || act === '2ACT' || act === '3ACT') return 'A320neo-' + act;
                // Basit eşleme: PW1100G -> neo, diğerleri -> ceo
                if (vU.startsWith('PW1100G')) {
                    return 'A320neo';
                }
                return 'A320-200';
            }
            if (famU === 'B737' || famU === 'B737 NG/MAX') {
                const vU = v.toUpperCase();
                if (vU.includes('MAX')) return 'B737MAX8/MAX9';
                return 'B737-700/800/900ER';
            }

            // Widebody: try combined (e.g. "A350 900" -> loader will normalize/partial match)
            if (fam && v) return fam + ' ' + v;
            return fam;
        }

        function updateBrandTankInfo() {
            const lang = getLang();
            const airbusSub = document.getElementById('brand-airbus-sub');
            const boeingSub = document.getElementById('brand-boeing-sub');
            const targetEl = (state.selectedOem === 'BOEING') ? boeingSub : airbusSub;
            if (!targetEl) return;

            // Seçim tamamlanmadıysa default metin kalsın
            if (!isSelectionComplete()) {
                targetEl.textContent = t(lang, 'brand_sub');
                return;
            }

            const key = selectionTankKey();
            const hasKgLoader = typeof window.fetchTankLimitsKg === 'function';

            const famU = String(state.selectedModel || '').toUpperCase();
            const isNarrow = (famU === 'A320 FAMILY' || famU === 'A319' || famU === 'A320' || famU === 'A321' || famU === 'B737' || famU === 'B737 NG/MAX');

            const renderKg = (limits) => {
                targetEl.textContent = '';

                const line1 = document.createElement('span');
                line1.style.color = 'var(--primary)';
                line1.style.fontWeight = '800';

                // Narrowbody: tankLimitsKg'den göster (10 KG adımına uygun şekilde aşağı yuvarla)
                if (isNarrow) {
                    const wingRaw = (limits && (typeof limits.leftWingFuelKg === 'number' || typeof limits.rightWingFuelKg === 'number'))
                        ? Math.max(0, Math.max(limits.leftWingFuelKg || 0, limits.rightWingFuelKg || 0))
                        : null;
                    const ctrRaw = (limits && typeof limits.centerFuelKg === 'number') ? Math.max(0, limits.centerFuelKg || 0) : null;

                    if (wingRaw == null || ctrRaw == null) {
                        line1.textContent = 'MAX: - KG';
                        targetEl.appendChild(line1);
                        targetEl.appendChild(document.createElement('br'));
                        const line2 = document.createElement('span');
                        line2.style.color = '#94a3b8';
                        line2.style.fontWeight = '800';
                        line2.textContent = 'WING: 2 x - | CTR: - KG';
                        targetEl.appendChild(line2);
                        return;
                    }

                    const wing = Math.floor(wingRaw / 10) * 10;
                    const ctr = Math.floor(ctrRaw / 10) * 10;
                    const max = (wing * 2) + ctr;
                    line1.textContent = 'MAX: ' + max.toLocaleString() + ' KG';
                    targetEl.appendChild(line1);

                    targetEl.appendChild(document.createElement('br'));
                    const line2 = document.createElement('span');
                    line2.style.color = '#94a3b8';
                    line2.style.fontWeight = '800';
                    line2.textContent = 'WING: 2 x ' + wing.toLocaleString() + ' | CTR: ' + ctr.toLocaleString() + ' KG';
                    targetEl.appendChild(line2);
                    return;
                }

                // Widebody: tankLimitsKg'den göster
                const totalKg = (limits && typeof limits.totalFuelKg === 'number') ? limits.totalFuelKg : null;
                line1.textContent = 'MAX: ' + (typeof totalKg === 'number' ? totalKg.toLocaleString() : '-') + ' KG';
                targetEl.appendChild(line1);

                const parts = [];
                if (limits && typeof limits.leftWingFuelKg === 'number') parts.push(['Sol', limits.leftWingFuelKg]);
                if (limits && typeof limits.rightWingFuelKg === 'number') parts.push(['Sağ', limits.rightWingFuelKg]);
                if (limits && typeof limits.centerFuelKg === 'number') parts.push(['Merkez', limits.centerFuelKg]);
                if (limits && typeof limits.trimFuelKg === 'number' && limits.trimFuelKg > 0) parts.push(['Trim', limits.trimFuelKg]);
                if (limits && typeof limits.actFuelKg === 'number' && limits.actFuelKg > 0) parts.push(['ACT', limits.actFuelKg]);

                if (parts.length) {
                    targetEl.appendChild(document.createElement('br'));
                    const line2 = document.createElement('span');
                    line2.style.color = '#94a3b8';
                    line2.style.fontWeight = '800';
                    line2.textContent = parts.map(([label, val]) => label + ': ' + Number(val).toLocaleString() + ' KG').join(' | ');
                    targetEl.appendChild(line2);
                }
            };

            if (!key) {
                targetEl.textContent = t(lang, 'brand_sub');
                return;
            }

            if (!hasKgLoader) {
                renderKg(null);
                return;
            }

            console.log('[DEBUG] selectionTankKey:', key);
            window.fetchTankLimitsKg(key)
                .then((limits) => {
                    console.log('[DEBUG] limits:', limits);
                    renderKg(limits);
                })
                .catch(() => renderKg(null));
        }

        function normalizeTail(s) {
            let raw = String(s || '').trim().toUpperCase().replaceAll(' ', '');
            if (!raw) return '';

            // Accept user input as just 3 letters/digits (e.g. "ABC") and prepend TC-
            if (/^[A-Z0-9]{3}$/.test(raw)) return 'TC-' + raw;

            // Accept "TCABC" or "TC-ABC"; normalize to "TC-ABC" (3 chars after TC-)
            if (raw.startsWith('TC-')) {
                const suf = raw.slice(3);
                if (/^[A-Z0-9]{3}$/.test(suf)) return 'TC-' + suf;
                return raw;
            }
            if (raw.startsWith('TC')) {
                const suf = raw.slice(2);
                const sufNoDash = suf.startsWith('-') ? suf.slice(1) : suf;
                if (/^[A-Z0-9]{3}$/.test(sufNoDash)) return 'TC-' + sufNoDash;
                return raw;
            }

            return raw;
        }

        function sanitizeTailValue(raw) {
            // Enforce single input with fixed prefix "TC-" and 3 chars after it.
            let v = String(raw || '').toUpperCase();
            v = v.replaceAll(' ', '');

            // Remove all but letters/digits and dash
            v = v.replaceAll(/[^A-Z0-9-]/g, '');

            // Accept "ABC" -> "TC-ABC"
            if (/^[A-Z0-9]{1,3}$/.test(v)) v = 'TC-' + v;

            // Accept "TCABC" -> "TC-ABC"
            if (v.startsWith('TC') && !v.startsWith('TC-')) {
                const suf = v.slice(2).replaceAll('-', '');
                v = 'TC-' + suf;
            }

            if (!v.startsWith('TC-')) {
                // Hard reset to prefix if something weird pasted
                v = 'TC-';
            }

            const suf = v.slice(3).replaceAll('-', '').slice(0, 3);
            v = 'TC-' + suf;
            return v;
        }

        function lockTailCaret(inputEl) {
            if (!inputEl) return;
            const minPos = 3;
            try {
                const s = inputEl.selectionStart ?? minPos;
                const e = inputEl.selectionEnd ?? minPos;
                const nextS = Math.max(minPos, s);
                const nextE = Math.max(minPos, e);
                if (nextS !== s || nextE !== e) inputEl.setSelectionRange(nextS, nextE);
            } catch (e) {}
        }

        function enforceTailInput() {
            const inputEl = document.getElementById('tail-input');
            if (!inputEl) return;
            const next = sanitizeTailValue(inputEl.value);
            if (inputEl.value !== next) inputEl.value = next;
            lockTailCaret(inputEl);
        }

        function isSupportedFamily(fam) {
            const f = String(fam || '').toUpperCase();
            return !!f;
        }

        function calcUrlForSelection(model, variant, oem, act) {
            const fam = String(model || '').toUpperCase();
            const mod = String(variant || '').toUpperCase();
            const brand = (oem === 'BOEING') ? 'BOEING' : 'AIRBUS';

            // tankLimitsKg anahtarını ayrı gönder (calc sayfasında limitler buradan okunur)
            const tankKey = (() => {
                if (fam === 'A320 FAMILY' || fam === 'A319' || fam === 'A320' || fam === 'A321') {
                    if (mod.startsWith('PW1100G')) {
                        const actU = String(act || '').toUpperCase();
                        if (actU === '1ACT' || actU === '2ACT' || actU === '3ACT') return 'A320neo-' + actU;
                        return 'A320neo';
                    }
                    return 'A320-200';
                }
                if (fam === 'B737' || fam === 'B737 NG/MAX') {
                    if (mod.includes('MAX')) return 'B737MAX8/MAX9';
                    return 'B737-700/800/900ER';
                }
                return '';
            })();

            // Narrowbody (existing limits)
            if (fam === 'A320 FAMILY' || fam === 'A319' || fam === 'A320' || fam === 'A321') {
                return 'calc.html?fleet=' + encodeURIComponent('A320 FAMILY')
                    + (tankKey ? ('&tankkey=' + encodeURIComponent(tankKey)) : '');
            }
            if (fam === 'B737' || fam === 'B737 NG/MAX') {
                return 'calc.html?fleet=' + encodeURIComponent('B737 NG/MAX')
                    + (tankKey ? ('&tankkey=' + encodeURIComponent(tankKey)) : '');
            }

            // Widebody: open calculator without enforcing tank limits
            const fleetLabel = (mod ? (fam + ' ' + mod) : fam);

            return 'calc.html?fleet=' + encodeURIComponent(brand + ' ' + fleetLabel)
                + (fleetLabel ? ('&tankkey=' + encodeURIComponent(fleetLabel)) : '');
        }

        function markBrandSelected(oem) {
            const wrapA = document.getElementById('brand-airbus-wrap');
            const wrapB = document.getElementById('brand-boeing-wrap');
            wrapA?.classList.toggle('selected', oem === 'AIRBUS');
            wrapB?.classList.toggle('selected', oem === 'BOEING');
        }

        function attachSelectorsTo(oem) {
            const host = document.getElementById('selectors-host');
            const modelRow = document.getElementById('model-row');
            const variantRow = document.getElementById('variant-row');
            if (!host || !modelRow || !variantRow) return;

            const wrap = document.getElementById(oem === 'BOEING' ? 'brand-boeing-wrap' : 'brand-airbus-wrap');
            if (!oem || !wrap) {
                if (modelRow.parentElement !== host) host.appendChild(modelRow);
                if (variantRow.parentElement !== host) host.appendChild(variantRow);
                return;
            }

            if (modelRow.parentElement !== wrap) wrap.appendChild(modelRow);
            if (variantRow.parentElement !== wrap) wrap.appendChild(variantRow);
        }

        function fillSelect(selectEl, placeholderText, values) {
            if (!selectEl) return;
            selectEl.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = placeholderText;
            selectEl.appendChild(opt0);
            // A319/A320/A321 -> A320 FAMILY birleştirme
            const merged = [];
            const seen = new Set();
            for (const v of values) {
                if (["A319","A320","A321"].includes(v)) {
                    if (!seen.has("A320 FAMILY")) {
                        merged.push("A320 FAMILY");
                        seen.add("A320 FAMILY");
                    }
                } else if (!seen.has(v)) {
                    merged.push(v);
                    seen.add(v);
                }
            }
            for (const v of merged) {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                selectEl.appendChild(opt);
            }
        }

        function setReveal(id, show) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('is-hidden', !show);
        }

        function applySelectionLock() {
            const locked = !!state.lockedByTail;
            const btnA = document.getElementById('brand-airbus');
            const btnB = document.getElementById('brand-boeing');
            const modelSelect = document.getElementById('model-select');
            const variantSelect = document.getElementById('variant-select');
            if (btnA) btnA.disabled = locked;
            if (btnB) btnB.disabled = locked;
            if (modelSelect && locked) modelSelect.disabled = true;
            if (variantSelect && locked) variantSelect.disabled = true;
        }

        function setLockedByTail(locked) {
            state.lockedByTail = !!locked;
            applySelectionLock();
        }

        function variantDisplayToken(model, variant) {
            const fam = String(model || '').toUpperCase();
            const v = String(variant || '').trim().toUpperCase();
            if (!v) return '';

            // Airbus A320 Family: show CEO/NEO (ACT seçimi ayrı bir alanda yapılır)
            if (fam === 'A320 FAMILY') {
                if (v.startsWith('PW1100G')) return 'NEO A319/A320/A321';
                if (v.startsWith('V2500')) return 'CEO A319/A320/A321';
                return v;
            }

            // Boeing 737: show NG / MAX prefixes (label only)
            if (fam === 'B737' || fam === 'B737 NG/MAX') {
                if (v.endsWith('MAX') && /^\dMAX$/.test(v)) {
                    const n = v.replace(/MAX$/, '');
                    return 'MAX -' + n;
                }
                if (/^\d{3}(-AJ)?$/.test(v)) return 'NG -' + v;
                return v;
            }

            return v;
        }

        function groupVariantsByCapacity(model, variants) {
            const famU = String(model || '').trim().toUpperCase();

            function variantTankKeyForGrouping(fam, variant) {
                const fU = String(fam || '').trim().toUpperCase();
                const vU = String(variant || '').trim().toUpperCase();
                if (!fU || !vU) return '';

                // Narrowbody capacity groups
                if (fU === 'A320 FAMILY' || fU === 'A319' || fU === 'A320' || fU === 'A321') {
                    // ACT seçim alanı ayrı: burada tüm PW1100G alt varyantlarını tek grupta topla
                    if (vU.startsWith('PW1100G')) return 'A320neo';
                    return 'A320-200';
                }
                if (fU === 'B737' || fU === 'B737 NG/MAX') {
                    if (vU.includes('MAX')) return 'B737MAX8/MAX9';
                    return 'B737-700/800/900ER';
                }

                // A330 capacity groups
                if (fU === 'A330') {
                    if (vU.startsWith('200') || vU === '243') return 'A330-200';
                    if (vU.startsWith('300')) return 'A330-300';
                    return 'A330-' + vU; // fallback
                }

                // Widebody: default grouping by exact variant (capacity may still be same, but this is deterministic)
                return fU + ' ' + vU;
            }

            function pickMainVariant(members) {
                const uniq = Array.from(new Set(members)).filter(Boolean);
                // Prefer a representative that is NOT an ACT-specific and NOT -AJ
                const nonAct = uniq.filter(v => !/\dACT$/i.test(v) && !v.includes('-1ACT') && !v.includes('-2ACT') && !v.includes('-3ACT'));
                const nonAj = nonAct.filter(v => !v.endsWith('-AJ'));
                const pool = (nonAj.length ? nonAj : (nonAct.length ? nonAct : uniq));
                pool.sort((a, b) => a.length - b.length || a.localeCompare(b));
                return pool[0] || '';
            }

            const groups = new Map();
            for (const raw of variants) {
                const v = String(raw || '').trim().toUpperCase();
                if (!v) continue;
                const key = variantTankKeyForGrouping(famU, v) || ('NAME:' + v);
                if (!groups.has(key)) groups.set(key, []);
                groups.get(key).push(v);
            }

            const mergedOptions = [];
            const memberToMain = new Map();

            for (const [key, members] of groups.entries()) {
                const sorted = Array.from(new Set(members)).sort();
                const main = pickMainVariant(sorted);
                for (const m of sorted) memberToMain.set(m, main);

                let label = '';
                if (famU === 'A320 FAMILY') {
                    if (key === 'A320neo') label = 'NEO A319/A320/A321';
                    else if (key === 'A320-200') label = 'CEO A319/A320/A321';
                    else label = variantDisplayToken(famU, main);
                } else if (famU === 'B737' || famU === 'B737 NG/MAX') {
                    const tokens = Array.from(new Set(sorted.map(v => variantDisplayToken('B737', v)).filter(Boolean)));
                    // Küçük/tekrarlı token'ları sadeleştir
                    label = tokens.sort().join(' / ');
                } else if (famU === 'A330') {
                    const tokens = Array.from(new Set(sorted.map(v => variantDisplayToken('A330', v)).filter(Boolean)));
                    label = tokens.sort().join(' / ');
                } else {
                    const tokens = Array.from(new Set(sorted.map(v => variantDisplayToken(famU, v)).filter(Boolean)));
                    label = tokens.sort().join(' / ');
                }

                if (main) mergedOptions.push({ value: main, label });
            }

            mergedOptions.sort((a, b) => a.label.localeCompare(b.label));
            return { mergedOptions, memberToMain };
        }

        // getVariantCapacityL removed: capacity merge is based on calculator configuration.

        function refreshSelectors() {
            const lang = getLang();
            const modelSelect = document.getElementById('model-select');
            const variantSelect = document.getElementById('variant-select');
            const goBtn = document.getElementById('go-btn');
            const goHint = document.getElementById('go-hint');
            if (!modelSelect || !variantSelect || !goBtn || !goHint) return;
            const modelPlaceholder = t(lang, 'model_placeholder');
            const variantPlaceholder = t(lang, 'variant_placeholder');
            if (!state.selectedOem) {
                attachSelectorsTo('');
                setReveal('model-row', false);
                setReveal('variant-row', false);
                modelSelect.disabled = true;
                variantSelect.disabled = true;
                fillSelect(modelSelect, modelPlaceholder, []);
                fillSelect(variantSelect, variantPlaceholder, []);
                goBtn.disabled = true;
                goHint.dataset.state = '';
                goHint.textContent = t(lang, 'go_hint_idle');
                // Limit bilgisini temizle
                const airbusSub = document.getElementById('brand-airbus-sub');
                const boeingSub = document.getElementById('brand-boeing-sub');
                if (airbusSub) airbusSub.innerHTML = t(lang, 'brand_sub');
                if (boeingSub) boeingSub.innerHTML = t(lang, 'brand_sub');
                applySelectionLock();
                return;
            }

            attachSelectorsTo(state.selectedOem);

            // Marka seçildi: Model alanını aç
            setReveal('model-row', true);

            // Model listesi (sadeleştirilmiş)
            let models = [];
            try {
                const m = state.byOem?.[state.selectedOem];
                if (m && typeof m.keys === 'function') {
                    models = Array.from(m.keys()).map(x => normalizeFamilyName(x));
                }
            } catch (e) {}
            models = Array.from(new Set(models)).sort();

            // Daha okunur sıralama: dar gövdeleri öne al
            try {
                const preferred = ['A320 FAMILY', 'B737 NG/MAX', 'B737', 'A330', 'A350-900', 'B777', 'B787'];
                models.sort((a, b) => {
                    const ia = preferred.indexOf(a);
                    const ib = preferred.indexOf(b);
                    if (ia !== -1 || ib !== -1) {
                        if (ia === -1) return 1;
                        if (ib === -1) return -1;
                        return ia - ib;
                    }
                    return a.localeCompare(b);
                });
            } catch (e) {}

            modelSelect.disabled = models.length === 0;
            fillSelect(modelSelect, modelPlaceholder, models);
            if (state.selectedModel && models.includes(state.selectedModel)) {
                modelSelect.value = state.selectedModel;
            } else {
                state.selectedModel = '';
                state.selectedVariant = '';
                modelSelect.value = '';
            }

            // Varyant listesi (sadeleştirilmiş)
            let variants = [];
            if (state.selectedModel) {
                try {
                    const m = state.byOem?.[state.selectedOem];
                    const set = m?.get?.(state.selectedModel);
                    if (set) variants = Array.from(set);
                } catch (e) {}
            }

            // Seçili varyant ACT içeriyorsa, ACT state'ini koru (merge sonrası kaybolmasın)
            try {
                const rawV = String(state.selectedVariant || '').toUpperCase();
                if (String(state.selectedModel || '').toUpperCase() === 'A320 FAMILY') {
                    if (rawV.includes('1ACT')) state.selectedAct = '1ACT';
                    else if (rawV.includes('2ACT')) state.selectedAct = '2ACT';
                    else if (rawV.includes('3ACT')) state.selectedAct = '3ACT';
                }
            } catch (e) {}

            const { mergedOptions, memberToMain } = groupVariantsByCapacity(state.selectedModel || '', variants);
            if (!state.selectedModel || mergedOptions.length === 0) {
                setReveal('variant-row', false);
                variantSelect.disabled = true;
                fillSelect(variantSelect, variantPlaceholder, []);
                state.selectedVariant = '';
                variantSelect.value = '';
            } else {
                // Varyantlar her zaman görünsün; seçenek tekse disabled kalabilir
                setReveal('variant-row', true);
                variantSelect.disabled = (mergedOptions.length <= 1);
                variantSelect.innerHTML = '';
                const opt0 = document.createElement('option');
                opt0.value = '';
                opt0.textContent = variantPlaceholder;
                variantSelect.appendChild(opt0);
                for (const opt of mergedOptions) {
                    const o = document.createElement('option');
                    o.value = opt.value;
                    o.textContent = opt.label;
                    variantSelect.appendChild(o);
                }
                let selectedVariant = state.selectedVariant;
                if (selectedVariant && !mergedOptions.some(o => o.value === selectedVariant)) {
                    const mapped = memberToMain.get(selectedVariant) || memberToMain.get(selectedVariant.replace(/-AJ$/, ''));
                    selectedVariant = mapped || '';
                }
                if (!selectedVariant && mergedOptions.length === 1) selectedVariant = mergedOptions[0].value;
                state.selectedVariant = selectedVariant;
                variantSelect.value = selectedVariant;
            }

            const supported = state.selectedModel && isSupportedFamily(state.selectedModel);
            goBtn.disabled = !supported;
            const fam = String(state.selectedModel || '').toUpperCase();
            const isNarrow = (fam === 'A319' || fam === 'A320' || fam === 'A321' || fam === 'A320 FAMILY' || fam === 'B737' || fam === 'B737 NG/MAX');
            if (!supported && state.selectedModel) {
                goHint.dataset.state = 'unsupported';
                goHint.textContent = t(lang, 'go_hint_unsupported');
            } else if (supported && !isNarrow) {
                goHint.dataset.state = 'widebody';
                goHint.textContent = t(lang, 'go_hint_widebody');
            } else {
                goHint.dataset.state = '';
                goHint.textContent = t(lang, 'go_hint_idle');
            }

            applySelectionLock();

            // Model/Varyant değişiminden sonra ACT satırını senkron tut
            try { updateActSelector(); } catch (e) {}

            // Seçim tamamlandıysa marka kartında tank/limit göster
            try { updateBrandTankInfo(); } catch (e) {}
        }

        function setSelection(oem, model, variant) {
            const m = normalizeFamilyName(model);
            state.selectedOem = oem || '';
            state.selectedModel = m || '';

            // Varyant: -AJ -> base (kapasite aynıysa)
            let v = String(variant || '').trim().toUpperCase();
            if (v && v.endsWith('-AJ')) {
                v = v.replace(/-AJ$/, '');
            }
            state.selectedVariant = v;

            markBrandSelected(state.selectedOem);
            refreshSelectors();
        }

        document.getElementById('brand-airbus')?.addEventListener('click', () => setSelection('AIRBUS', '', ''));
        document.getElementById('brand-boeing')?.addEventListener('click', () => setSelection('BOEING', '', ''));
        document.getElementById('model-select')?.addEventListener('change', (e) => {
            const v = e.target?.value || '';
            state.selectedModel = v;
            state.selectedVariant = '';
            state.selectedAct = '';
            refreshSelectors();
        });
        document.getElementById('variant-select')?.addEventListener('change', (e) => {
            state.selectedVariant = e.target?.value || '';
            // ACT inputunu güncelle
            updateActSelector();
            updateBrandTankInfo();
        });

        document.getElementById('act-select')?.addEventListener('change', (e) => {
            state.selectedAct = e.target?.value || '';
            updateBrandTankInfo();
        });

        // Seçilen varyanta göre ACT inputunu göster/gizle ve seçenekleri doldur
        function updateActSelector() {
            const actRow = document.getElementById('act-row');
            const actSelect = document.getElementById('act-select');
            if (!actRow || !actSelect) return;

            const selectedValue = String(state.selectedVariant || '').trim().toUpperCase();

            // ACT yalnızca A320 FAMILY NEO (PW1100G) için
            const show = (String(state.selectedModel || '').toUpperCase() === 'A320 FAMILY') && selectedValue.startsWith('PW1100G');
            if (!show) {
                actRow.classList.add('is-hidden');
                actSelect.value = '';
                state.selectedAct = '';
                actSelect.disabled = false;
                updateBrandTankInfo();
                return;
            }

            // A320neo için ACT seçenekleri: fleet.json'da ACT'li varyant olmasa bile kullanıcı seçebilsin.
            const lang = getLang();
            const actOptions = [
                { value: 'YOK', label: t(lang, 'act_none') },
                { value: '1ACT', label: t(lang, 'act_1') },
                { value: '2ACT', label: t(lang, 'act_2') },
                { value: '3ACT', label: t(lang, 'act_3') }
            ];

            actSelect.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = t(lang, 'act_placeholder');
            actSelect.appendChild(opt0);
            for (const opt of actOptions) {
                const o = document.createElement('option');
                o.value = opt.value;
                o.textContent = opt.label;
                actSelect.appendChild(o);
            }

            // Seçilen varyant ACT içermiyorsa (veya belirsizse) varsayılan: YOK
            // Not: A320 FAMILY varyantları kapasiteye göre gruplanıp PW1100G tek seçeneğe indirgenebilir;
            // bu yüzden ACT bilgisi çoğu zaman state.selectedAct üzerinden yürür.
            const vU = selectedValue;
            if (vU.includes('1ACT')) state.selectedAct = '1ACT';
            else if (vU.includes('2ACT')) state.selectedAct = '2ACT';
            else if (vU.includes('3ACT')) state.selectedAct = '3ACT';
            else if (!state.selectedAct || !actOptions.some(o => o.value === state.selectedAct)) state.selectedAct = 'YOK';

            actRow.classList.remove('is-hidden');

            // Eğer kullanıcı seçmediyse, default olarak YOK'u tamamlanmış say
            if (!state.selectedAct) {
                state.selectedAct = 'YOK';
            }

            // Seçimi her zaman UI'a yansıt (placeholder'da kalmasın)
            const prevValue = actSelect.value;
            actSelect.value = state.selectedAct;
            // Eğer programatik olarak değiştiyse, change event tetikle
            if (prevValue !== actSelect.value) {
                const event = new Event('change', { bubbles: true });
                actSelect.dispatchEvent(event);
            }

            // Kuyruk kodu ile kilitliyse ve ACT'li uçaksa değiştirmeyi engelle
            actSelect.disabled = !!state.lockedByTail;
            updateBrandTankInfo();
        }

        document.getElementById('go-btn')?.addEventListener('click', () => {
            const url = calcUrlForSelection(state.selectedModel, state.selectedVariant, state.selectedOem, state.selectedAct);
            if (url) window.location.href = url;
        });

        function updateTailHint(kind, payload) {
            const lang = getLang();
            const hint = document.getElementById('tail-hint');
            if (!hint) return;
            hint.dataset.state = kind;
            if (kind === 'loading') hint.textContent = t(lang, 'tail_hint_loading');
            else if (kind === 'notfound') hint.textContent = t(lang, 'tail_hint_notfound');
            else if (kind === 'found') {
                const p = payload || {};
                const model = String(p.model || '').trim();
                const variant = String(p.variant || '').trim();
                hint.textContent = t(lang, 'tail_hint_found', {
                    model,
                    variant: variant ? (' ' + variant) : ''
                });
            }
            else {
                hint.dataset.state = '';
                hint.textContent = t(lang, 'tail_hint_idle');
            }
        }

        function applyTailLookup(raw) {
            const tail = normalizeTail(raw);
            if (!tail || tail === 'TC-' || tail.length < 6) {
                setLockedByTail(false);
                updateTailHint('idle');
                return;
            }
            const hit = state.tailMap.get(tail);
            if (!hit) {
                setLockedByTail(false);
                updateTailHint('notfound');
                return;
            }
            setSelection(hit.oem, hit.family, hit.model);
            setLockedByTail(true);
            updateTailHint('found', { model: normalizeFamilyName(hit.family), variant: hit.model });

            // ACT otomatik seçimi: Eğer model A320 FAMILY ve varyant PW1100G-... ise
            // hit.model içinde ACT tipi varsa (ör. PW1100G-3ACT), bunu seç
            setTimeout(function() {
                const actSelect = document.getElementById('act-select');
                if (!actSelect) return;
                // Sadece ACT satırı görünürse uygula
                const actRow = document.getElementById('act-row');
                if (!actRow || actRow.classList.contains('is-hidden')) return;
                let actValue = '';
                if (typeof hit.model === 'string' && hit.model.toUpperCase().startsWith('PW1100G')) {
                    const mU = hit.model.toUpperCase();
                    if (mU.includes('1ACT')) { actValue = '1ACT'; }
                    else if (mU.includes('2ACT')) { actValue = '2ACT'; }
                    else if (mU.includes('3ACT')) { actValue = '3ACT'; }
                    else { actValue = 'YOK'; }
                }
                if (actValue) {
                    actSelect.value = actValue;
                    state.selectedAct = actValue;
                    try { updateBrandTankInfo(); } catch (e) {}
                }
                // Kuyruk kodu ile seçim kilitliyse ACT seçimi her zaman pasif
                actSelect.disabled = !!state.lockedByTail;
            }, 10);
        }

        let tailDebounce = null;
        const tailInput = document.getElementById('tail-input');
        if (tailInput) {
            // Init fixed prefix
            tailInput.value = 'TC-';
            try { tailInput.setSelectionRange(3, 3); } catch (e) {}
        }

        tailInput?.addEventListener('focus', () => {
            enforceTailInput();
            // Always keep caret after prefix
            window.setTimeout(() => lockTailCaret(tailInput), 0);
        });
        tailInput?.addEventListener('click', () => window.setTimeout(() => lockTailCaret(tailInput), 0));
        tailInput?.addEventListener('mouseup', () => window.setTimeout(() => lockTailCaret(tailInput), 0));

        tailInput?.addEventListener('keydown', (e) => {
            if (!tailInput) return;
            const s = tailInput.selectionStart ?? 0;
            const ePos = tailInput.selectionEnd ?? 0;

            // Prevent deleting the fixed prefix
            if ((e.key === 'Backspace' && s <= 3 && ePos <= 3) || (e.key === 'Delete' && s < 3)) {
                e.preventDefault();
                lockTailCaret(tailInput);
                return;
            }
            if (e.key === 'Home') {
                e.preventDefault();
                tailInput.setSelectionRange(3, 3);
                return;
            }
            if (e.key === 'ArrowLeft' && s <= 3) {
                e.preventDefault();
                tailInput.setSelectionRange(3, 3);
                return;
            }

            // If user selects across prefix, re-lock to after prefix.
            if (s < 3 || ePos < 3) {
                window.setTimeout(() => lockTailCaret(tailInput), 0);
            }
        });

        tailInput?.addEventListener('input', () => {
            // User is manually editing tail; unlock until bir tail bulunana kadar serbest bırak.
            enforceTailInput();
            // Kuyruk kodu tam ve doğru değilse model seçimini ve kilidi sıfırla
            const val = tailInput.value;
            // TC- ile başlıyor ve 6 karakterden kısa ise veya TC- değilse
            if (!val || val === 'TC-' || val.length < 6 || !/^TC-[A-Z0-9]{3}$/.test(val)) {
                setLockedByTail(false);
                setSelection('', '', '');
            }
            if (tailDebounce) window.clearTimeout(tailDebounce);
            tailDebounce = window.setTimeout(() => applyTailLookup(val), 250);
        });
        tailInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                enforceTailInput();
                applyTailLookup(tailInput.value);
            }
        });

        function seedFamiliesIfEmpty() {
            // Make manual selection usable even if fleet data fails to load.
            if (state.byOem.AIRBUS.size === 0) {
                ['A320 FAMILY', 'A330', 'A350-900'].forEach(f => state.byOem.AIRBUS.set(f, new Set()));
            }
            if (state.byOem.BOEING.size === 0) {
                ['B737 NG/MAX', 'B777', 'B787'].forEach(f => state.byOem.BOEING.set(f, new Set()));
            }
        }

        function normalizeFamilyName(familyRaw) {
            const f = String(familyRaw || '').trim().toUpperCase();
            if (f === 'A319' || f === 'A320' || f === 'A321') return 'A320 FAMILY';
            if (f === 'A350') return 'A350-900';
            if (f.startsWith('A350')) return 'A350-900';

            // Keep widebody families merged under a single model name
            if (f === 'A330' || f.startsWith('A330')) return 'A330';

            // Boeing families
            if (f === 'B737' || f.startsWith('B737')) return 'B737 NG/MAX';
            if (f === 'B777' || f.startsWith('B777')) return 'B777';
            if (f === 'B787' || f.startsWith('B787')) return 'B787';
            // Already-canonical values pass through
            return f;
        }

        function ingestFleetRow(tailRaw, familyRaw, modelRaw) {
            const tail = normalizeTail(tailRaw);
            const family = normalizeFamilyName(familyRaw);
            const model = String(modelRaw || '').trim().toUpperCase();
            if (!tail || !family) return;
            const oem = family.startsWith('A') ? 'AIRBUS' : 'BOEING';
            if (!state.byOem[oem].has(family)) state.byOem[oem].set(family, new Set());
            if (model) state.byOem[oem].get(family).add(model);
            state.tailMap.set(tail, { oem, family, model });
        }

        async function loadFleetJson() {
            updateTailHint('loading');
            const res = await fetch('assets/fleet.json', { cache: 'no-cache' });
            if (!res.ok) throw new Error('fleet.json fetch failed');
            const data = await res.json();

            // tailMap
            if (data && data.tailMap) {
                for (const [tail, v] of Object.entries(data.tailMap)) {
                    ingestFleetRow(tail, v.family, v.model);
                }
            }

            // Optional per-tail capacity overrides (generated). Non-fatal if missing.
            // tailCapacity.json artık sadece tankLimitsKg (KG) içerir.
            // byOem (optional, used mainly to include families even if tailMap is partial)
            if (data && data.byOem) {
                for (const [oem, fams] of Object.entries(data.byOem)) {
                    const key = (String(oem).toUpperCase() === 'BOEING') ? 'BOEING' : 'AIRBUS';
                    if (!fams) continue;
                    for (const [family, models] of Object.entries(fams)) {
                        if (!state.byOem[key].has(family)) state.byOem[key].set(family, new Set());
                        if (Array.isArray(models)) {
                            for (const m of models) if (m) state.byOem[key].get(family).add(String(m).trim().toUpperCase());
                        }
                    }
                }
            }

            seedFamiliesIfEmpty();
            state.dataReady = true;
            updateTailHint('idle');
        }

        seedFamiliesIfEmpty();
        loadFleetJson()
            .then(() => {
                refreshSelectors();
                // Eğer kullanıcı fleet yüklenmeden kuyruk girdiyse, yükleme sonrası tekrar dene
                try {
                    const v = document.getElementById('tail-input')?.value || '';
                    if (/^TC-[A-Z0-9]{3}$/.test(String(v).toUpperCase())) applyTailLookup(v);
                } catch (e) {}
            })
            .catch(() => {
                updateTailHint('idle');
                seedFamiliesIfEmpty();
                refreshSelectors();
                // Offline/timeout vb. durumda cache'den gelen tailMap yine de dolu olabilir; bir kez daha dene
                try {
                    const v = document.getElementById('tail-input')?.value || '';
                    if (/^TC-[A-Z0-9]{3}$/.test(String(v).toUpperCase())) applyTailLookup(v);
                } catch (e) {}
            });
    })();
    </script>
</body>
</html>
